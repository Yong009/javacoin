<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>변동성 돌파 자동매매</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>

		#wrap-changeAuto{

		}


    </style>
</head>
<body id="wrap-changeAuto">
<div id="header"></div>
<div >

    <h4 hidden><span>자동매매 : </span><span id="auto" ></span></h4>
    <h4 >변동성 돌파 전략 이란?&nbsp;&nbsp;&nbsp;<span>오늘의 목표가 : &nbsp;</span><span id="todayPrice"></span></h4>
    <p>전날 종가, 최고가, 저가를 이용해서 변동성을 확인 후 그 적정 가격에 구매를 한뒤, 변동이 큰 아침 9시에 파는 전략입니다. </p>
    <p>리스트를 최소화한 대신 리턴도 적은 전략입니다.</p><br/>
    <p >※access키와 secret키를 잔고 조회 페이지에서 저장 시 자동매매 기능을 사용하실 수 있습니다.※</p><br/>

    <!--<label for="access2" style="font-weight: bold;" hidden>access키</label><br/><br/>
    <input id="access2" type="text" class="form-control" style="width:300px;" hidden/><br/><br/>
    <label for="secret2" style="font-weight: bold;" hidden>secret키</label><br/><br/>
    <input id="secret2" type="text" style="margin-left:4px; width:300px;" class="form-control" hidden/><br/>-->
    <p >※만원 단위로 기입하셔야 하며 0도 다 적어주셔야합니다.!!!!! 아닐 시 자동매매가 안될 수도 있습니다.※</p><br/>
    <label for="price" id="account3" >금액(원)</label><br/><br/>
    <input id="price" type="text" /><br/>
    <button id="startTrading" >자동 매매 시작</button>
    <button id="stopTrading" >자동 매매 중지</button>
</div>

<div id="footer" ></div>


<script>
    $('#header').load('header.html')
    $('#footer').load('footer.html')

    var username = '[[${user}]]';
    console.log(username);

    var userid = {
        id: username
    }

    $.ajax({
        url: "/getCode",
        type: "POST",
        data: JSON.stringify(userid),
        dataType: "json",
        contentType: "application/json",
        success: function (result) {
            $('#access2').val(result[0].accessCode);
            var a = $('#access').val();
            $('#secret2').val(result[0].secretCode)
            var b = $('#secret').val();

            if (result[0].auto == 'Y') {
                $('#auto').text('on');
            } else {
                $('#auto').text('off');
            }

            if ($('#auto').text() == 'on') {
                $('#auto').css("color", "red");
                $('#auto').css("font-weight", "bold");
            } else {
                $('#auto').css("color", "blue");
                $('#auto').css("font-weight", "bold");
            }


        }
    })

    /*setInterval(function () {

        $.ajax({
            url: "/getCode",
            type: "POST",
            data: JSON.stringify(userid),
            dataType: "json",
            contentType: "application/json",
            success: function (result) {
                $('#access2').val(result[0].accessCode);
                var a = $('#access').val();
                $('#secret2').val(result[0].secretCode)
                var b = $('#secret').val();

                if (result[0].auto == 'Y') {
                    $('#auto').text('on');
                } else {
                    $('#auto').text('off');
                }

                if ($('#auto').text() == 'on') {
                    $('#auto').css("color", "red");
                    $('#auto').css("font-weight", "bold");
                } else {
                    $('#auto').css("color", "blue");
                    $('#auto').css("font-weight", "bold");
                }


            }
        })

    },3000);*/

    $('#startTrading').on('click', function () {



        $.ajax({
            url: "/getCode",
            type: "POST",
            data: JSON.stringify(userid),
            dataType: "json",
            contentType: "application/json",
            success: function (result) {

                if (result[0].auto == 'Y') {
                    $('#auto').text('on');
                } else {
                    $('#auto').text('off');
                }

                if ($('#auto').text() == 'on') {
                    $('#auto').css("color", "red");
                    $('#auto').css("font-weight", "bold");
                } else {
                    $('#auto').css("color", "blue");
                    $('#auto').css("font-weight", "bold");
                }


            }
        })


        var acc = $('#access2').val();
        var sec = $('#secret2').val();
        var price = $('#price').val();
        var username = '[[${user}]]';
        var member = {
            accessCode: acc,
            secretCode: sec,
            id: username
        }
        var member2 = {
            autoPrice: price,
            id: username
        }

        $.ajax({
            url: "/autoTrade2",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(member),
            contentType: "application/json",
            success: function (result) {
                alert("자동매매 실행 성공!!!")
            }
        })

        $.ajax({
            url: "/saveAutoPrice",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(member2),
            contentType: "application/json",
            success: function (result) {

            }
        })

		alert("자동매매를 시작하겠습니다.")
    })

    $('#stopTrading').on('click', function () {

        $.ajax({
            url: "/getCode",
            type: "POST",
            data: JSON.stringify(userid),
            dataType: "json",
            contentType: "application/json",
            success: function (result) {

                if (result[0].auto == 'Y') {
                    $('#auto').text('on');
                } else {
                    $('#auto').text('off');
                }

                if ($('#auto').text() == 'on') {
                    $('#auto').css("color", "red");
                    $('#auto').css("font-weight", "bold");
                } else {
                    $('#auto').css("color", "blue");
                    $('#auto').css("font-weight", "bold");
                }


            }
        })


        var username = '[[${user}]]';
        var member = {
            id: username
        }


        $.ajax({
            url: "/autoStop",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(member),
            contentType: "application/json",
            success: function (userid) {
                alert("자동매매 끄기 성공!!!")
            }
        })

		alert("자동매매를 종료하겠습니다.")
    })

    $.ajax({
        url: "/getCode",
        type: "POST",
        data: JSON.stringify(userid),
        dataType: "json",
        contentType: "application/json",
        success: function (result) {

            var acc = result[0].accessCode
            var sec = result[0].secretCode

            var account2 = {
                accessCode: acc,
                secretCode: sec
            }

            $.ajax({
                url: "/account7",
                type: "POST",
                dataType: "json",
                data: JSON.stringify(account2),
                contentType: "application/json",
                success: function (result2) {

                    $.each(result2, function (i, item) {
                        if (item.currency == 'KRW') {
                        	let balance = Math.floor(item.balance / 10000) * 10000;
                            $('#account3').text("금액 " + "(잔액 : " + Math.floor(item.balance) + "원)");
                            $('#price').val(Math.floor(balance));
                        }

                    })

                }
            })


        }
    })

	var seq = {
		seq : "1"
    }


    $.ajax({
		url:"/yesterdayPrice",
		type:"GET",
		dataType:"json",
		contentType:"application/json",
		success:function(result){

			var targetPrice;

			  $.ajax({
			        url: "/currentPrice7",
			        type: "Get",
			        dataType: "json",
			        contentType: "application/json",
			        success: function (result2) {

			      		$.each(result2,function(i,item){

			      			if(result2[i].market == 'KRW-BTC'){
								targetPrice = result2[i].prev_closing_price + ((result[0].highPrice - result[0].lowPrice) * 0.5);
								$('#todayPrice').text(targetPrice);

			      			}

			      		})

			        }
			    })
		}
	})



    // $.ajax({
    // 	url:"/market7",
    // 	type:"Get",
    // 	dataType:"json",
    // 	contentType:"application/json",
    // 	success: function(result){
    //
    // 		console.log(result);
    //
    // 	}
    // })


   /*   */

</script>
</body>
</html>